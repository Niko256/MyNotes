Современные микропроцессоры входят в число наиболее сложных систем, когда-либо созданных человеком. Один кремниевый кристалл может содержать несколько несколько производительных ядер, кэш, а также логику, необходимую для взаимодействия с внешними устройствами. Современные процессоры превосходят по производительности суперкомпьютеры прошлого, занимавшие целые помещения и стоившие миллионы долларов.


Основное назначение процессора - это выполнение последовательности инструкций, написанных на машинном языке.

Любая инструкция кодируется в двоичном представлении в виде последовательности одного или нескольких байтов.

---
## Instruction Set Architecture

Инструкции, поддерживаемые конкретным процессором и их кодирование на уровне байт называется ***архитектурой набора команд `(ISA)`***. Разные семейства процессоров имеют разные `ISA`. 

Поэтому программа, скомпилированная для машины одного типа, не будет выполняться на машине другого типа, если их архитектуры набора команд различны.

Архитектура набора команд играет одну из ключевых ролей в проектировании процессоров, обеспечивая уровень абстракции аппаратного обеспечения, который предоставляет разработчикам компиляторов простой и понятный интерфейс для работы с данными процессорами.

Также `ISA` обеспечивает совместимость программного обеспечения с различными процессорами, реализующими одну и ту же архитектуру.

Модель `ISA` конечно же предполагает последовательное выполнение инструкций, при котором каждая инструкция извлекается из физической памяти, выполняется до конца, прежде чем будет извлечена последующая инструкция.

---
## Registers

Регистры играют важнейшую роль в архитектуре процессора, обеспечивая быстрый доступ к данным и повышая эффективность выполнения операций.

Регистр - это ячейка физической памяти определённой разрядности, расположенная на чипе процессора, предназначенная для временного значения данных и инструкций, с которыми работает процессор.

В регистрах хранятся операнды, результаты вычислений, а также адреса памяти. Множество хранимых данных будем называть **контекстом выполняемого процесса**.

Количество регистров и их назначение определяется архитектурой процессора, на котором они установлены. 

Разрядность регистра определяет максимальный размер данных в битах, с которыми ядро процессора может работать в течении выполнения инструкции. Данное число бит также называется **Машинным словом**.

Разделим множество регистров на несколько категорий:

- Регистры общего назначения.
	- Данные регистры используются для хранения контекста процесса (`rax`, `rbx`, `rcx`, `rdx`, `rsi`, `rdi`, `rbp`, `rsp`, `r8`, `r9`, `r10`, `r11`, `r12`, `r13`, `r14`, `r15`)

- `RFLAGS` (Регистр флагов)
	- содержит флаги, указывающие на состояние процессора после выполнения операции (`CF`, `ZF`, `SF`, `OF`, ...)

- `RIP` (instruction pointer, 64 bit long)
	- содержит адрес следующей инструкции, которая будет выполнена ядром процессора

- Сегментные регистры (16 bits long)
	- `CS` - хранит адрес сегмента кода/текста процесса
	- `DS` - хранит адрес сегмента данных процесса
	- `SS` - хранит адрес сегмента стека процесса
	- `ES`, `GS`, `FS` - дополнительные регистры для различных целей () 

- `DR0-DR7` (Регистры отладки)
	- содержат адреса и информацию о точках остановки (breakpoints)

- `CR0`, `CR2`, `CR3`, `CR4` (Регистры управления)
	- управляют режимами работы ядра процессора и защитой памяти, `CR3` хранит базовый адрес таблицы страниц

- `GDTR`, `LDTR`, `IDTR`, `TR` (Системные регистры)
	- содержат адреса глобальной и локальной таблиц дескрипторов, а также адрес текущей задачи (`Task Register`)

---
## Instructions

Ранее мы ввели понятие архитектуры набора команд. Теперь подробно разберёмся с самими командами, которые входят в `ISA`.

В данном конспекте будет рассмотрено множество инструкций, определённых для архитектуры `x86-64`, которая является самой распостранённой на данный момент.

Архитектура `x86-64`, также известная как `AMD64`, представляет собой 64-битное расширение архитектуры `x86`.

В данной архитектуре инструкции представляются в виде машинного кода, который биективно отображается на ассемблерные команды. Это отображение включает в себя преобразование символических идентификаторов команд в **коды операций (opcodes)**, а также определение способа кодирования операндов и режима адресации.

Пусть $A$ - ассемблерная инструкция, $M$ - соответствующий машинный код. Тогда отображение $\phi : A \rightarrow M$ можно представить как:

$$\phi(A) = M$$

Ассемблерная инструкция может быть представлена в виде следующих компонент:

```
A = (opcode, operands, addressing_modes)
```

- `opcode` - это идентификатор инструкции (например `MOV`, `JMP`)
- `operands` - это операнды инструкции (например `rax`, `10`)
- `addressing_modes` - идентификатор режима адресации (например `register`, `memory`)


Таким образом, отображение $\phi$ преобразует каждый компонент ассемблерной инструкции в соответствующие биты машинного кода

Инструкции в `x86-64` можно разделить на несколько категорий:

- Арифметические операции: арифметика, сдвиги, побитовые операции
- Перемещение данных: перемещение данных между регистрами, памятью и портами
- Логические операции: `AND`, `OR`, `XOR`, `NOT`
- Управление потоком: условные переходы, вызов функций
- Системные команды: работа с операционной системой (например управление привилегиями, обработка прерываний)
- `SIMD`-операции: параллельная обработка данных
- Математические операции: обработка чисел с плавающей запятой

Также существует ряд расширений, таких как:
- `SSE`
- `AVX`
- `AES`
- `SHA`


Как же тогда данный набор инструкций кодируется в машинном коде?

Первый байт каждой инструкции определяет её тип.

- `opcode` - каждому символическому идентификатору соответствует уникальный код операции, который представляет из себя битовую последовательность
- `operands` - операнды кодируются в зависимости от их типа и размера
- `addressing_modes` - режимы адресации кодируются с использованием префиксов и полей в машинном коде, которые указывают как именно интерпретировать операнды

Например рассмотрим следующую инструкцию:
- `MOV [RDI+4], RAX` (записать значение из 64-битного регистра `RAX` в память по адресу `[RDI+4]`)
	- Для 64-битного режима используется префикс `REX.W` (значение `48h`), который указывает, что операция работает с 64-битными операндами
	- `opcode` для `MOV` - `89h`
	- `ModR/M`:
	    - Поле `ModR/M` определяет режим адресации и операнды
	    - Для адресации `[RDI + смещение]` и регистра `RAX`:
		    - `mod` = `01` (адресация со смещением размером 1 байт).
		    - `reg` = `000` (регистр `RAX`).
		    - `r/m` = `111` (регистр `RDI`).
    - Итоговое значение `ModR/M`: `01 000 111` = `47h`.

	Таким образом, в машинном коде данная инструкция представляется в виде: `48 89 47 04`. Однако для Исполнительного блока процессора (Execution unit) данная инструкция представится в виде `01001000 10001001 01000111 00000100`, что как раз и является двоичным представлением чисел `48 89 47 04`.



Одним из важных свойств любой системы команд является уникальная интерпретация байтовой последовательности. Произвольная байтовая последовательность либо отображается в уникальную последовательность инструкций, либо является недопустимой. Данное свойство обеспечивает выполнение ядром процессора объектного кода, смысл которого определяется однозначно. Даже если данный машинный код встроен в другие байты программы, последовательность инструкций легко определяется до тех пор, **пока отсчёт ведётся с первого байта последовательности**.


---
## Operation modes

Режим работы процессора - это набор правил и конфигураций, определяющий интерпретацию инструкций ядром процессора, их обработку и управление памятью. Различные режимы работы позволяют процессору адаптироваться к разным типам задач и обеспечивать совместимость с различными операционными системами и предыдущими поколениями процессоров.


Основные режимы работы архитектуры `x86-64`:

- `Real mode`
	- Это режим, в котором работали первые процессоры `x86` (например, Intel 8086).
	- Отсутствует защита памяти и многозадачность.
	- поддерживает 16-битные регистры.
	- Используется для совместимости с устаревшими операционными системами (например, MS-DOS).

- `Protected mode`
	- поддерживает 16-битные и 32-битные регистры
	- поддерживает сегментацию памяти, страничную организацию памяти и многозадачность

- `Long mode` - поддерживает полный диапазон 64-битной виртуальной адресации и расширения регистров до 64 битной разрядности

- `Debug mode`

- `Power managment mode`

`Long mode` состоит из двух других режимов: `64-bit mode` и `Compatibility mode`.

- `64-bit mode` - это основной режим для запуска и работы 64-битных операционных систем и приложений. Он поддерживает полную 64-битную адресацию и расширения регистров.

- `Compatibility mode` - это режим, который позволяет 64-битным операционным системам запускать существующие 16-битные и 32-битные приложения. Использует 32-битную или 16-битную адресацию и регистры аналогичной разрядности

 


В многоядерной компьютерной системе, каждое ядро может работать в своём собственном режиме работы.

Ядро может переключаться между режимами с помощью специальных инструкций и настроек в регистрах управления.

---
